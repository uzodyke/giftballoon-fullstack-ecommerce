---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Breadcrumb from '@/components/Breadcrumb.astro';

const breadcrumbItems = [
  { label: 'Home', href: '/' },
  { label: 'Shop', href: '/shop' },
  { label: 'Checkout', href: '/checkout' },
  { label: 'Order Confirmation' }
];

// Order confirmation schema
const confirmationSchema = {
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": "Order Confirmation - Personalised Balloons",
  "description": "Your personalised balloon order has been confirmed and is being processed",
  "url": "https://giftedballoon.com/order-confirmation"
};
---

<BaseLayout
  title="Order Confirmation | Your Balloon Order is Confirmed | Gifted Balloon"
  description="Thank you for your personalised balloon order! Your order has been confirmed and will be delivered as scheduled. Track your order and contact support if needed."
  ogImage="/images/5. Love bouquet_Â£30.png"
  schema={confirmationSchema}
  keywords="order confirmation, balloon order confirmed, personalised balloon delivery, order tracking"
>
  <!-- Breadcrumb -->
  <Breadcrumb items={breadcrumbItems} />

  <!-- Order Confirmation Page -->
  <section class="py-16 bg-gradient-to-br from-green-50 via-blue-50 to-green-100 min-h-screen">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">

      <!-- Success Header -->
      <div class="text-center mb-12">
        <div class="inline-flex items-center justify-center w-24 h-24 bg-green-500 rounded-full mb-6">
          <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
        </div>

        <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
          Order Confirmed! ðŸŽ‰
        </h1>
        <p class="text-xl text-gray-600 max-w-2xl mx-auto">
          Thank you for your order! Your personalised balloon is being prepared and will be delivered as scheduled.
        </p>
      </div>

      <!-- Order Details Card -->
      <div class="bg-white rounded-2xl shadow-xl overflow-hidden mb-8">
        <div class="bg-gradient-to-r from-primary-500 to-primary-600 text-white p-6">
          <h2 class="text-2xl font-bold mb-2">Order Details</h2>
          <p class="opacity-90">Order #<span id="orderNumber">GFB-{Date.now().toString().slice(-8)}</span></p>
          <p class="opacity-90">Placed on <span id="orderDate">{new Date().toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</span></p>
        </div>

        <!-- Order Items -->
        <div class="p-6">
          <h3 class="text-lg font-bold text-gray-900 mb-4">Your Items</h3>
          <div id="orderItemsContainer">
            <!-- Items will be loaded here by JavaScript -->
          </div>
        </div>

        <!-- Order Summary -->
        <div class="p-6 bg-gray-50 border-t border-gray-200">
          <div class="space-y-2">
            <div class="flex justify-between">
              <span>Subtotal:</span>
              <span id="confirmSubtotal" class="font-semibold">Â£0.00</span>
            </div>
            <div class="flex justify-between">
              <span>Delivery:</span>
              <span id="confirmDeliveryFee" class="font-semibold">Â£5.99</span>
            </div>
            <div class="flex justify-between text-lg font-bold text-primary-600 border-t border-gray-200 pt-2">
              <span>Total Paid:</span>
              <span id="confirmGrandTotal">Â£5.99</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Customer & Delivery Info -->
      <div class="grid md:grid-cols-2 gap-8 mb-8">
        <!-- Customer Info -->
        <div class="bg-white rounded-2xl p-6 shadow-xl">
          <h3 class="text-xl font-bold text-gray-900 mb-4">Customer Information</h3>
          <div id="customerInfo" class="space-y-2 text-gray-600">
            <!-- Customer details will be loaded here -->
          </div>
        </div>

        <!-- Delivery Info -->
        <div class="bg-white rounded-2xl p-6 shadow-xl">
          <h3 class="text-xl font-bold text-gray-900 mb-4">Delivery Information</h3>
          <div id="deliveryInfo" class="space-y-2 text-gray-600">
            <!-- Delivery details will be loaded here -->
          </div>
        </div>
      </div>

      <!-- Next Steps -->
      <div class="bg-white rounded-2xl p-8 shadow-xl mb-8">
        <h3 class="text-2xl font-bold text-gray-900 mb-6 text-center">What Happens Next?</h3>

        <div class="grid md:grid-cols-3 gap-6">
          <div class="text-center">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 text-blue-600 rounded-full mb-4">
              <span class="text-2xl">ðŸ“§</span>
            </div>
            <h4 class="font-bold text-gray-900 mb-2">Email Confirmation</h4>
            <p class="text-gray-600 text-sm">You'll receive an email confirmation with your order details within 5 minutes.</p>
          </div>

          <div class="text-center">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-yellow-100 text-yellow-600 rounded-full mb-4">
              <span class="text-2xl">ðŸŽ¨</span>
            </div>
            <h4 class="font-bold text-gray-900 mb-2">Balloon Preparation</h4>
            <p class="text-gray-600 text-sm">Our team will start preparing your personalised balloon with your custom text.</p>
          </div>

          <div class="text-center">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 text-green-600 rounded-full mb-4">
              <span class="text-2xl">ðŸšš</span>
            </div>
            <h4 class="font-bold text-gray-900 mb-2">Delivery</h4>
            <p class="text-gray-600 text-sm">Your balloon will be delivered on your chosen date and time slot.</p>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <a
          href="/shop"
          class="bg-primary-500 hover:bg-primary-600 text-white px-8 py-4 rounded-lg font-bold text-center transition-colors"
        >
          Order Another Balloon
        </a>
        <button
          onclick="window.print()"
          class="border-2 border-primary-500 text-primary-500 hover:bg-primary-500 hover:text-white px-8 py-4 rounded-lg font-bold transition-colors"
        >
          Print Order Details
        </button>
      </div>

      <!-- Support Section -->
      <div class="mt-12 text-center">
        <div class="bg-gradient-to-r from-primary-500 to-primary-600 text-white rounded-2xl p-8">
          <h3 class="text-2xl font-bold mb-4">Need Help with Your Order?</h3>
          <p class="mb-6 opacity-90">Our customer service team is here to assist you with any questions about your order.</p>

          <div class="grid sm:grid-cols-2 gap-6">
            <div class="text-center">
              <div class="text-2xl mb-2">ðŸ“ž</div>
              <h4 class="font-bold mb-1">Call Us</h4>
              <a href="tel:+447459665002" class="text-white hover:text-primary-200 underline">
                +44 7459 665002
              </a>
              <p class="text-sm opacity-75 mt-1">Mon-Sun: 9AM-8PM</p>
            </div>

            <div class="text-center">
              <div class="text-2xl mb-2">ðŸ“§</div>
              <h4 class="font-bold mb-1">Email Us</h4>
              <a href="mailto:info@giftedballoon.com" class="text-white hover:text-primary-200 underline">
                info@giftedballoon.com
              </a>
              <p class="text-sm opacity-75 mt-1">24/7 Support</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</BaseLayout>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    loadOrderDetails();

    // Clear cart after successful order
    localStorage.removeItem('cart');
    localStorage.removeItem('checkoutData');
  });

  function loadOrderDetails() {
    // Get order data from session storage (set during checkout)
    const orderData = sessionStorage.getItem('lastOrder');

    if (!orderData) {
      // Fallback for direct access - redirect to shop
      window.location.href = '/shop';
      return;
    }

    const order = JSON.parse(orderData);

    // Display order items
    displayOrderItems(order.items || []);

    // Display order summary
    updateOrderSummary(order);

    // Display customer and delivery info
    displayCustomerInfo(order.customer || {});
    displayDeliveryInfo(order.delivery || {});
  }

  function displayOrderItems(items) {
    const container = document.getElementById('orderItemsContainer');

    if (!items || items.length === 0) {
      container.innerHTML = '<p class="text-gray-500">No items found</p>';
      return;
    }

    container.innerHTML = items.map(item => `
      <div class="flex items-start space-x-4 p-4 border border-gray-200 rounded-lg">
        <img
          src="${item.product?.image || item.image}"
          alt="${item.product?.name || item.name}"
          class="w-16 h-16 object-contain rounded-lg bg-gradient-to-br from-pink-50 to-purple-50 p-2"
        />
        <div class="flex-1">
          <h4 class="font-semibold text-gray-900">${item.product?.name || item.name}</h4>
          <div class="text-sm text-gray-600 space-y-1 mt-1">
            <p><strong>Custom Text:</strong> "${item.customization?.customName || item.customName}"</p>
            <p><strong>Occasion:</strong> ${item.customization?.occasionType || item.occasionType}</p>
            <p><strong>Delivery Date:</strong> ${item.customization?.deliveryDate || item.deliveryDate}</p>
            <p><strong>Quantity:</strong> ${item.quantity}</p>
          </div>
        </div>
        <div class="text-right">
          <p class="font-bold text-primary-600">Â£${(item.totalPrice || item.unitPrice * item.quantity).toFixed(2)}</p>
        </div>
      </div>
    `).join('');
  }

  function updateOrderSummary(order) {
    const subtotal = order.subtotal || 0;
    const deliveryFee = order.deliveryFee || 0;
    const total = order.total || (subtotal + deliveryFee);

    document.getElementById('confirmSubtotal').textContent = `Â£${subtotal.toFixed(2)}`;
    document.getElementById('confirmDeliveryFee').textContent = deliveryFee === 0 ? 'FREE' : `Â£${deliveryFee.toFixed(2)}`;
    document.getElementById('confirmGrandTotal').textContent = `Â£${total.toFixed(2)}`;
  }

  function displayCustomerInfo(customer) {
    const container = document.getElementById('customerInfo');

    container.innerHTML = `
      <div><strong>Name:</strong> ${customer.firstName || ''} ${customer.lastName || ''}</div>
      <div><strong>Email:</strong> ${customer.email || 'Not provided'}</div>
      <div><strong>Phone:</strong> ${customer.phone || 'Not provided'}</div>
    `;
  }

  function displayDeliveryInfo(delivery) {
    const container = document.getElementById('deliveryInfo');

    container.innerHTML = `
      <div><strong>Address:</strong></div>
      <div class="ml-4">
        ${delivery.address || 'Not provided'}<br>
        ${delivery.city || ''} ${delivery.postcode || ''}<br>
        ${delivery.country || 'United Kingdom'}
      </div>
      <div class="mt-2"><strong>Delivery Date:</strong> ${delivery.date || 'Not specified'}</div>
      <div><strong>Time Slot:</strong> ${delivery.timeSlot || 'Not specified'}</div>
      ${delivery.instructions ? `<div><strong>Instructions:</strong> ${delivery.instructions}</div>` : ''}
    `;
  }
</script>

<style>
  @media print {
    body * {
      visibility: hidden;
    }

    .print-area, .print-area * {
      visibility: visible;
    }

    .print-area {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
    }

    button, .no-print {
      display: none !important;
    }
  }
</style>